#!/bin/bash

# Comment out this block if you're a sillyhead
if [[ $EUID -eq 0 ]]; then
  echo "Why are you running me as root, sillyhead?"
  exit 2
fi

NOTESWITHFLATS=(A Bb B C Db D Eb E F Gb G Ab)
NOTESWITHSHARPS=(A A# B C C# D D# E F F# G G#)

# Tunings
TUNING_PREFIX=Tuning_
DEFAULTTUNING=Standard
TUNINGS=(\
  Standard\
  "Drop D"\
)

# Root Notes
DEFAULTROOTNOTE=C

# Scale Types
DEFAULTSCALETYPE="Natural Major"
SCALETYPES=(\
  "Natural Major"
  "Natural Minor"
  "Major Pentatonic"
  "Minor Pentatonic"
)
Natural_Major=(2 2 1 2 2 2 1)
Natural_Minor=(2 1 2 2 1 2 2)
Major_Pentatonic=(2 2 3 2)
Minor_Pentatonic=(3 2 2 3)

function generate_scale {
  scaletype="$1"
  rootnote="$2"
  
  eval scale_alias=( \"\${${scaletype}[@]}\" )
  sharpflatdisplay=`grep ^SHARPFLATDISPLAY $CONFIGFILE | sed 's/.*=//'`
  if [[ "$sharpflatdisplay" = "Sharps" ]]; then
    NOTES="${NOTESWITHSHARPS[@]}"
  else
    NOTES="${NOTESWITHFLATS[@]}"
  fi
  note_index=0
  # Get index of root note
  for note in ${NOTES[@]}; do
    if [[ "$note" = "$rootnote" ]]; then
      root_index=$note_index
    fi
  note_index=$((note_index+1))
  done
  for movement in ${scale_alias[@]}; do
    cur_index=$((note_index+movement))
    if [[ "$cur_index" -gt 11 ]]; then
      cur_index=$((cur_index-12))
    fi 
    echo "${NOTES[$cur_index]}"
  done
}

function generate_scale {
  NOTES=()
  rootnote="$1"
  scaletype="$2"
  scale=("$rootnote")
  eval scale_alias=( \"\${${scaletype}[@]}\" )
  sharpflatdisplay=`grep ^SHARPFLATDISPLAY $CONFIGFILE | sed 's/.*=//'`
  if [[ "$sharpflatdisplay" = "Sharps" ]]; then
    for note in ${NOTESWITHSHARPS[@]}; do
      NOTES+=("$note")
    done
  else
    for note in ${NOTESWITHFLATS[@]}; do
      NOTES+=("$note")
    done
  fi
  note_index=0
  # Get index of root note
  for note in ${NOTES[@]}; do
    if [[ "$note" = "$rootnote" ]]; then
      root_index=$note_index
    fi
  note_index=$((note_index+1))
  done
  cur_index=$root_index
  for movement in ${scale_alias[@]}; do
    cur_index=$((cur_index+movement))
    if [[ "$cur_index" -gt 11 ]]; then
      cur_index=$((cur_index-12))
    fi
    if [[ "$cur_index" = "$root_index" ]]; then
      break
    fi
    scale+=("${NOTES[$cur_index]}")
  done
}

# Generate default config if needed
CONFIGFILE="$HOME/.config/retrojam/config"
CONFIGDIR=`dirname $CONFIGFILE`
if [ ! -d $CONFIGDIR ]; then
  mkdir -p $CONFIGDIR
fi
if [ ! -f $CONFIGFILE ]; then
  cat <<EOF > $CONFIGFILE
ROOTNOTE=$DEFAULTROOTNOTE
SCALETYPE=$DEFAULTSCALETYPE
SHARPFLATDISPLAY=Sharps
TUNING=$DEFAULTTUNING
EOF
fi

function retune_menu {
  clear
  PS3="Enter the number for your desired tuning: "
  select tuning_choice in "${TUNINGS[@]}"; do
    sed -i "s/^TUNING=.*/TUNING=$tuning_choice/" $CONFIGFILE
    break
  done
}

function choose_notes {
  NOTES=()
  sharpflatdisplay=`grep ^SHARPFLATDISPLAY $CONFIGFILE | sed 's/.*=//'`
  if [[ "$sharpflatdisplay" = "Sharps" ]]; then
    for note in ${NOTESWITHSHARPS[@]}; do
      NOTES+=("$note")
    done
  else
    for note in ${NOTESWITHFLATS[@]}; do
      NOTES+=("$note")
    done
  fi
}

function scale_type_menu {
  clear
  echo "Reference:"
  echo "Major Scales"
  echo "============"
  echo "Major scales have a major third which makes them feel happy or bright."
  echo "Major scales include: Natural Major, Mixolydian, Lydian, Lydian Dominant, Phrygian Dominant, Harmonic Major, iand Mixolydian b6."
  echo ""
  echo "Minor Scales"
  echo "============"
  echo "Minor scales have a flat third which gives them a darker and more tragic feel."
  echo "Minor scales include: Natural Minor, Dorian, Harmonic Minor, Melodic Minor, Phrygian, and Locrian"
  echo ""
  echo "Neither Major nor Minor"
  echo "======================="
  echo "These include: Blues and Altered"
  echo ""
  echo "Pentatonic Scales"
  echo "================="
  echo "Pentatonic scales consist of five notes."
  echo "Pentatonic scales include: Major Pentatonic and Minor Pentatonic"
  echo ""
  echo "Synthetic Scales" 
  echo "================"
  echo "Synthetic scales include: Chromatic, Whole Tone and Octatonic"
  echo "=========================================================================================================="
  echo ""
  echo ""
  echo ""
  PS3="Enter the number for your desired scale type: "
  select scale_type_choice in "${SCALETYPES[@]}"; do
    sed -i "s/^SCALETYPE=.*/SCALETYPE=$scale_type_choice/" $CONFIGFILE
    break
  done
}

function root_note_menu {
  clear
  choose_notes
  PS3="Enter the number for your desired root note: "
  select root_note_choice in "${NOTES[@]}"; do
    sed -i "s/^ROOTNOTE=.*/ROOTNOTE=$root_note_choice/" $CONFIGFILE
    break
  done
}
  
function main_menu {
  clear
  echo "\

██████╗ ███████╗████████╗██████╗  ██████╗      ██╗ █████╗ ███╗   ███╗
██╔══██╗██╔════╝╚══██╔══╝██╔══██╗██╔═══██╗     ██║██╔══██╗████╗ ████║
██████╔╝█████╗     ██║   ██████╔╝██║   ██║     ██║███████║██╔████╔██║
██╔══██╗██╔══╝     ██║   ██╔══██╗██║   ██║██   ██║██╔══██║██║╚██╔╝██║
██║  ██║███████╗   ██║   ██║  ██║╚██████╔╝╚█████╔╝██║  ██║██║ ╚═╝ ██║
╚═╝  ╚═╝╚══════╝   ╚═╝   ╚═╝  ╚═╝ ╚═════╝  ╚════╝ ╚═╝  ╚═╝╚═╝     ╚═╝"

  tuning=`grep ^TUNING $CONFIGFILE | sed 's/.*=//'`
  rootnote=`grep ^ROOTNOTE $CONFIGFILE | sed 's/.*=//'`
  sharpflatdisplay=`grep ^SHARPFLATDISPLAY $CONFIGFILE | sed 's/.*=//'`
  scaletype=`grep ^SCALETYPE $CONFIGFILE | sed 's/.*=//'`

  echo ""
  echo "Current Settings:"
  echo "================="
  echo "Tuning: $tuning"
  echo "Root Note: $rootnote"
  echo "Scale Type: $scaletype"
  scaletype=`echo $scaletype | tr ' ' '_'`
  generate_scale "$rootnote" "$scaletype"
  echo "Scale Notes: ${scale[@]}"
  echo ""

  echo "Main menu"
  echo "========="
  PS3="Enter the number for your menu selection: "
  select choice in \
    Play\
    "Change Root Note"\
    "Change Scale Type"\
    Retune\
    "Toggle: Show Sharp or Flat Notes. Currently showing $sharpflatdisplay"\
    Quit; do

    case $choice in
      Play)
        break
        ;;
      "Change Root Note")
        root_note_menu
        break
        ;;
      "Change Scale Type") 
	scale_type_menu
	break
        ;;
      Retune)
        retune_menu
	break
        ;;
"Toggle: Show Sharp or Flat Notes. Currently showing $sharpflatdisplay")
        if [[ "$sharpflatdisplay" = "Sharps" ]]; then 
	  sharpflatdisplay="Flats"
	else
	  sharpflatdisplay="Sharps"
	fi
        sed -i "s/^SHARPFLATDISPLAY=.*/SHARPFLATDISPLAY=$sharpflatdisplay/" $CONFIGFILE
	choose_notes

	# Translate flat root note to sharp
        echo $rootnote | grep 'b' > /dev/null
	if [ $? -eq 0 ]; then
          index=0
          for val in ${NOTESWITHFLATS[@]}; do
            if [[ "$val" = "$rootnote" ]]; then
              rootnote="${NOTESWITHSHARPS[$index]}"
	      sed -i "s/^ROOTNOTE=.*/ROOTNOTE=$rootnote/" $CONFIGFILE
	      break
	    fi
            index=$((index+1))   
	  done
          break
	fi
	
	# Translate sharp root note to flat
        echo $rootnote | grep '#' > /dev/null
	if [ $? -eq 0 ]; then
          index=0
          for val in ${NOTESWITHSHARPS[@]}; do
            if [[ "$val" = "$rootnote" ]]; then
              rootnote="${NOTESWITHFLATS[$index]}"
	      sed -i "s/^ROOTNOTE=.*/ROOTNOTE=$rootnote/" $CONFIGFILE
	      break
	    fi
            index=$((index+1))   
	  done
	fi
    	break
	;;
      Quit)
        exit 0
        ;;
      *)
        echo "Invalid option $REPLY"
        ;;
    esac
  done
}

choose_notes
while : ;do
  main_menu
done
